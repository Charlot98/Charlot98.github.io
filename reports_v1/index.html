<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…ä¾‹ä¿¡æ¯ä¸Šä¼  - ç½‘é¡µ1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 32px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .content {
            padding: 32px;
        }

        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .form-group label .required {
            color: #dc3545;
            margin-left: 4px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group.readonly {
            background: #f8f9fa;
        }

        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .file-list {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .file-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e7f3ff;
            border-radius: 6px;
            font-size: 13px;
        }

        .file-item button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 0;
            font-size: 16px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .format-btn {
            padding: 8px 16px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .format-btn:hover {
            background: #667eea;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 32px;
            padding-top: 32px;
            border-top: 2px solid #e0e0e0;
        }

        .info-note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ ç—…ä¾‹ä¿¡æ¯ä¸Šä¼ </h1>
            <p>è¯·å¡«å†™ç—…ä¾‹åŸºæœ¬ä¿¡æ¯</p>
        </div>

        <div class="content">
            <form id="caseForm">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="section">
                    <h2 class="section-title">åŸºæœ¬ä¿¡æ¯</h2>
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>ç—…ä¾‹å½±åƒä¸‹è½½URL <span class="required">*</span></label>
                            <input type="url" id="imageUrl" required placeholder="è¯·è¾“å…¥å½±åƒä¸‹è½½URL">
                        </div>


                        <div class="form-group">
                            <label>å¹´é¾„ <span class="required">*</span></label>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="age" required min="0" placeholder="è¯·è¾“å…¥å¹´é¾„" style="flex: 1;">
                                <select id="ageUnit" required style="width: 100px;">
                                    <option value="å²">å²</option>
                                    <option value="æœˆé¾„">æœˆé¾„</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>æ€§åˆ« <span class="required">*</span></label>
                            <select id="gender" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="é›„æ€§">é›„æ€§</option>
                                <option value="é›„æ€§å»åŠ¿">é›„æ€§å»åŠ¿</option>
                                <option value="é›Œæ€§">é›Œæ€§</option>
                                <option value="é›Œæ€§ç»è‚²">é›Œæ€§ç»è‚²</option>
                            </select>
                        </div>

                        <div class="form-group full-width">
                            <label>ç—…å² <span class="required">*</span></label>
                            <textarea id="medicalHistory" required placeholder="è¯·è¾“å…¥ç—…å²"></textarea>
                        </div>

                        <div class="form-group full-width">
                            <label>ä¸»è¯‰ <span class="required">*</span></label>
                            <textarea id="chiefComplaint" required placeholder="è¯·è¾“å…¥ä¸»è¯‰"></textarea>
                        </div>

                        <div class="form-group">
                            <label>ç—…ä¾‹ç±»å‹ <span class="required">*</span></label>
                            <select id="caseType" required>
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="Xçº¿">Xçº¿</option>
                                <option value="Bè¶…">Bè¶…</option>
                                <option value="CT">CT</option>
                                <option value="MRI">MRI</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- æœ€ç»ˆç‰ˆæŠ¥å‘Š -->
                <div class="section">
                    <h2 class="section-title">æœ€ç»ˆç‰ˆæŠ¥å‘Šï¼ˆå…³é”®è¯æ ‡æ³¨ï¼‰</h2>
                    <div class="info-note">
                        ğŸ’¡ æç¤ºï¼šé€‰ä¸­æ–‡æœ¬åç‚¹å‡»"åŠ ç²—é€‰ä¸­æ–‡æœ¬"æŒ‰é’®æ¥æ ‡æ³¨å¿…é¡»ç­”åˆ°çš„å…³é”®è¯ã€‚æ ‡æ³¨çš„å…³é”®è¯å°†åœ¨å¯¹æ¯”æ—¶é«˜äº®æ˜¾ç¤ºã€‚
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>æœ€ç»ˆç‰ˆæŠ¥å‘Šæ‰€è§</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                <button type="button" class="format-btn" onclick="formatText('findingsFinal', 'bold')">ğŸ“ åŠ ç²—é€‰ä¸­æ–‡æœ¬</button>
                            </div>
                            <textarea id="findingsFinal" placeholder="è¯·è¾“å…¥æœ€ç»ˆç‰ˆæŠ¥å‘Šæ‰€è§ã€‚é€‰ä¸­æ–‡æœ¬åç‚¹å‡»æŒ‰é’®æ¥æ ‡æ³¨å…³é”®è¯ã€‚" style="min-height: 150px;">æ­¤å¤„æ˜¯<strong>æœ€ç»ˆæŠ¥å‘Šæ‰€è§</strong>çš„ç¤ºä¾‹å†…å®¹ã€‚å…³é”®è¯ä¼šè¢«<strong>åŠ ç²—æ ‡æ³¨</strong>ã€‚</textarea>
                        </div>

                        <div class="form-group full-width">
                            <label>æœ€ç»ˆç‰ˆæŠ¥å‘Šç»“è®º</label>
                            <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                <button type="button" class="format-btn" onclick="formatText('conclusionFinal', 'bold')">ğŸ“ åŠ ç²—é€‰ä¸­æ–‡æœ¬</button>
                            </div>
                            <textarea id="conclusionFinal" placeholder="è¯·è¾“å…¥æœ€ç»ˆç‰ˆæŠ¥å‘Šç»“è®ºã€‚é€‰ä¸­æ–‡æœ¬åç‚¹å‡»æŒ‰é’®æ¥æ ‡æ³¨å…³é”®è¯ã€‚" style="min-height: 150px;">æ­¤å¤„æ˜¯<strong>æœ€ç»ˆæŠ¥å‘Šç»“è®º</strong>çš„ç¤ºä¾‹å†…å®¹ã€‚é‡è¦<strong>å…³é”®è¯</strong>ä¼šè¢«æ ‡æ³¨ã€‚</textarea>
                        </div>
                    </div>
                </div>

                <!-- è¾…åŠ©ä¿¡æ¯ -->
                <div class="section">
                    <h2 class="section-title">è¾…åŠ©ä¿¡æ¯ï¼ˆéå¿…å¡«ï¼‰</h2>
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>å®éªŒå®¤æ£€æŸ¥</label>
                            <div class="file-upload-area" id="labCheckArea">
                                <input type="file" id="labCheckFiles" multiple accept="image/*">
                                <div>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯å¤šé€‰ï¼‰</div>
                            </div>
                            <div class="file-list" id="labCheckFileList"></div>
                        </div>

                        <div class="form-group full-width">
                            <label>Bè¶…æ£€æŸ¥</label>
                            <div class="file-upload-area" id="ultrasoundArea">
                                <input type="file" id="ultrasoundFiles" multiple accept="image/*">
                                <div>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯å¤šé€‰ï¼‰</div>
                            </div>
                            <div class="file-list" id="ultrasoundFileList"></div>
                        </div>

                        <div class="form-group full-width">
                            <label>Xçº¿æ£€æŸ¥</label>
                            <div class="file-upload-area" id="xrayArea">
                                <input type="file" id="xrayFiles" multiple accept="image/*">
                                <div>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯å¤šé€‰ï¼‰</div>
                            </div>
                            <div class="file-list" id="xrayFileList"></div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">âœ… æäº¤å¹¶ç”Ÿæˆç—…ä¾‹ç¼–å·</button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">ğŸ”„ æ¸…ç©ºè¡¨å•</button>
                    <a href="preview.html" class="btn btn-secondary">ğŸ“‹ æŸ¥çœ‹ç—…ä¾‹åˆ—è¡¨</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // éšæœºç”Ÿæˆå§“å
        function generateRandomName() {
            const surnames = ['å¼ ', 'ç‹', 'æ', 'èµµ', 'åˆ˜', 'é™ˆ', 'æ¨', 'é»„', 'å‘¨', 'å´'];
            const names = ['ä¼Ÿ', 'èŠ³', 'å¨œ', 'ç§€è‹±', 'æ•', 'é™', 'ä¸½', 'å¼º', 'ç£Š', 'å†›', 'æ´‹', 'å‹‡', 'è‰³', 'æ°', 'å¨Ÿ', 'æ¶›', 'æ˜', 'è¶…', 'ç§€å…°'];
            const surname = surnames[Math.floor(Math.random() * surnames.length)];
            const name = names[Math.floor(Math.random() * names.length)] + (Math.random() > 0.5 ? '' : names[Math.floor(Math.random() * names.length)]);
            return surname + name;
        }

        // å­˜å‚¨ç”Ÿæˆçš„å§“åï¼ˆä¸æ˜¾ç¤ºç»™ç”¨æˆ·ï¼‰
        let generatedName = '';
        
        // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆéšæœºå§“åï¼ˆä½†ä¸æ˜¾ç¤ºï¼‰
        window.addEventListener('DOMContentLoaded', function() {
            generatedName = generateRandomName();
        });
        
        // ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
        async function uploadFileToServer(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('http://localhost:5000/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.statusText}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    return {
                        name: file.name,
                        path: result.path,
                        url: result.url
                    };
                } else {
                    throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('æ–‡ä»¶ä¸Šä¼ é”™è¯¯:', error);
                // å¦‚æœæœåŠ¡å™¨ä¸å¯ç”¨ï¼Œå›é€€åˆ° Base64
                return convertFileToBase64(file);
            }
        }

        // å°†æ–‡ä»¶è½¬æ¢ä¸ºbase64ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    name: file.name,
                    data: reader.result // base64æ•°æ®
                });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // æ ¼å¼åŒ–æ–‡æœ¬åŠŸèƒ½
        function formatText(textareaId, type) {
            const textarea = document.getElementById(textareaId);
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (!selectedText) {
                alert('è¯·å…ˆé€‰ä¸­è¦æ ‡æ³¨çš„æ–‡æœ¬');
                return;
            }
            
            let replacement;
            if (type === 'bold' || type === 'keyword') {
                replacement = `<strong>${selectedText}</strong>`;
            }
            
            const newText = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
            textarea.value = newText;
            
            // æ¢å¤ç„¦ç‚¹å’Œå…‰æ ‡ä½ç½®
            textarea.focus();
            const newPos = start + replacement.length;
            textarea.setSelectionRange(newPos, newPos);
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function setupFileUpload(inputId, listId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            const area = input.closest('.file-upload-area');

            area.addEventListener('click', () => input.click());
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.style.borderColor = '#667eea';
            });
            area.addEventListener('dragleave', () => {
                area.style.borderColor = '#dee2e6';
            });
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.style.borderColor = '#dee2e6';
                input.files = e.dataTransfer.files;
                updateFileList(input, list);
            });

            input.addEventListener('change', () => updateFileList(input, list));
        }

        function updateFileList(input, list) {
            list.innerHTML = '';
            Array.from(input.files).forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span>ğŸ“„ ${file.name}</span>
                    <button type="button" onclick="removeFile('${input.id}', ${index})">Ã—</button>
                `;
                list.appendChild(item);
            });
        }

        function removeFile(inputId, index) {
            const input = document.getElementById(inputId);
            const dt = new DataTransfer();
            Array.from(input.files).forEach((file, i) => {
                if (i !== index) dt.items.add(file);
            });
            input.files = dt.files;
            const listId = inputId.replace('Files', 'FileList');
            updateFileList(input, document.getElementById(listId));
        }

        // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
        setupFileUpload('labCheckFiles', 'labCheckFileList');
        setupFileUpload('ultrasoundFiles', 'ultrasoundFileList');
        setupFileUpload('xrayFiles', 'xrayFileList');

        // è¡¨å•æäº¤
        document.getElementById('caseForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶åˆ°æœåŠ¡å™¨
            const labCheckFiles = Array.from(document.getElementById('labCheckFiles').files);
            const ultrasoundFiles = Array.from(document.getElementById('ultrasoundFiles').files);
            const xrayFiles = Array.from(document.getElementById('xrayFiles').files);

            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'â³ æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...';
            submitBtn.disabled = true;

            try {
                const formData = {
                    imageUrl: document.getElementById('imageUrl').value,
                    patientName: generatedName || generateRandomName(),
                    age: document.getElementById('age').value,
                    ageUnit: document.getElementById('ageUnit').value,
                    gender: document.getElementById('gender').value,
                    medicalHistory: document.getElementById('medicalHistory').value,
                    chiefComplaint: document.getElementById('chiefComplaint').value,
                    caseType: document.getElementById('caseType').value,
                    finalReport: {
                        findings: document.getElementById('findingsFinal').value,
                        conclusion: document.getElementById('conclusionFinal').value
                    },
                    labCheckFiles: await Promise.all(labCheckFiles.map(uploadFileToServer)).catch(() => []),
                    ultrasoundFiles: await Promise.all(ultrasoundFiles.map(uploadFileToServer)).catch(() => []),
                    xrayFiles: await Promise.all(xrayFiles.map(uploadFileToServer)).catch(() => [])
                };

                // ä¿å­˜åˆ°localStorageå¹¶ç”Ÿæˆç—…ä¾‹ç¼–å·
                saveCaseAndGenerateId(formData);
            } catch (error) {
                alert('ä¸Šä¼ å›¾ç‰‡æ—¶å‡ºé”™: ' + error.message);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }

            // ä¿å­˜åˆ°localStorageå¹¶ç”Ÿæˆç—…ä¾‹ç¼–å·
            saveCaseAndGenerateId(formData);
        });

        // ä¿å­˜ç—…ä¾‹å¹¶ç”Ÿæˆç¼–å·
        function saveCaseAndGenerateId(caseData) {
            // è·å–å·²æœ‰ç—…ä¾‹
            let cases = JSON.parse(localStorage.getItem('cases') || '[]');
            
            // ç”Ÿæˆç—…ä¾‹ç¼–å·
            const prefix = {
                'Xçº¿': 'DR',
                'Bè¶…': 'UL',
                'CT': 'CT',
                'MRI': 'MRI'
            }[caseData.caseType];

            // è·å–è¯¥ç±»å‹çš„æœ€æ–°ç¼–å·
            const sameTypeCases = cases.filter(c => c.caseId && c.caseId.startsWith(prefix));
            let maxNum = 0;
            sameTypeCases.forEach(c => {
                const num = parseInt(c.caseId.replace(prefix, ''));
                if (num > maxNum) maxNum = num;
            });
            
            const caseId = prefix + String(maxNum + 1).padStart(6, '0');
            
            // æ·»åŠ ç—…ä¾‹IDå’Œæ—¶é—´æˆ³
            caseData.caseId = caseId;
            caseData.createTime = new Date().toISOString();
            
            // ä¿å­˜
            cases.push(caseData);
            localStorage.setItem('cases', JSON.stringify(cases));

            alert(`ç—…ä¾‹å·²æäº¤ï¼\nç—…ä¾‹ç¼–å·ï¼š${caseId}`);
            
            // è·³è½¬åˆ°é¢„è§ˆé¡µé¢
            window.location.href = 'preview.html';
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
                document.getElementById('caseForm').reset();
                generatedName = generateRandomName();
                document.getElementById('labCheckFileList').innerHTML = '';
                document.getElementById('ultrasoundFileList').innerHTML = '';
                document.getElementById('xrayFileList').innerHTML = '';
            }
        }
    </script>
</body>
</html>

